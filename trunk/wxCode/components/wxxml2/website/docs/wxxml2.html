<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>wxXml2: wxXml2Wrappers and reference counting.</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1><a class="anchor" name="wxxml2">wxXml2Wrappers and reference counting.</a></h1>wxXml2Wrapper-derived classes does not use a full Copy-On-Write technique: when copying a wxXml2Wrapper you just create a new wxXml2Wrapper (which requires few bytes) which wraps the same libxml2 structure of the original wxXml2Wrapper. Consider the following code: <div class="fragment"><pre class="fragment">                <a class="code" href="classwxXml2Document.html">wxXml2Document</a> doc;
                <a class="code" href="classwxXml2Node.html">wxXml2Node</a> root(doc, <span class="stringliteral">"root_of_my_doc"</span>);
                
                <span class="comment">// copy the root node</span>
                <a class="code" href="classwxXml2Node.html">wxXml2Node</a> copy(root);
                copy.SetName(<span class="stringliteral">"myroot"</span>);         <span class="comment">// modify the copy</span>
           
                <span class="comment">// save the document</span>
                doc.<a class="code" href="classwxXml2Document.html#a12">Save</a>(....);
</pre></div>The result won't be a document with a root named "root_of_my_doc" but a document with "myroot" as root's name. This is because deep copies are never performed, unlike, for example, in wxString's COW system where the string is shared until a non-const function is called. The libxml2 structure is always shared with wxXml2Wrapper.<p>
However, a reference count is still required to avoid things like: <div class="fragment"><pre class="fragment">                <a class="code" href="classwxXml2Node.html">wxXml2Node</a> mynode;
                mynode.Create(...);
                {
                    <a class="code" href="classwxXml2Node.html">wxXml2Node</a> copy(mynode);
                    [...]
                } <span class="comment">// "copy" is destroyed</span>
                mynode.<a class="code" href="classwxXml2Node.html#z3_1">AddChild</a>(...);
</pre></div>Without reference counting, in fact, the code above would create the "copy" node which would destroy its libxml2 node when being destroyed. This must be avoided because "mynode" is still wrapping that memory address: with reference counting, this is avoided. The reference count must be stored in the wrapped structure. How wxXml2Wrapper handle this problem ? Well, all libxml2 structure has a VOID* field called "_private" which can be safely used by external functions to hold user contents. The <a class="el" href="classwxXml2Wrapper.html#b2">GetPrivate()</a> function casts that pointer to a reference to a integer so that it can be used as an int instead of a pointer to void.<p>
One last note about libxml2 structure destruction: if you read the <a class="el" href="classwxXml2Wrapper.html#a4">wxXml2Wrapper::DestroyIfUnlinked</a> function's sources, you'll notice that the wrapped libxml2 structure is not destroyed when the reference count reaches zero but the <a class="el" href="classwxXml2Wrapper.html#a2">IsUnlinked()</a> function returns FALSE; why ? Because libxml2 implements "recursive destruction": when a node is destroyed, all its children are too. This means that we must also be careful not to break libxml2 memory representation destroying a node's child when it's still linked to its parent. To be exact, when a node (but also a property, a dtd, a namespace...) is part of a wider XML tree, we must *never* delete it when the relative wxXml2Wrapper is destroyed. This is because the wxXml2Wrappers are built on the fly by the getters of another wxXml2Wrapper: a libxml2 node does not have automatically associated a <a class="el" href="classwxXml2Node.html">wxXml2Node</a> and thus a tree composed of wxXml2Nodes does not exist in memory. If we would delete a libxml2 node in the wxXml2Node's destructor when it's still linked to a wider tree we would destroy <hr size="1"><address style="align: right;"><small>Generated on Sat Jan 1 21:15:08 2005 for wxXml2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
